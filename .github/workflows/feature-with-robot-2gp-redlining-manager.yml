on:
  workflow_call:
    inputs:
      cumulusci-version:
        required: false
        type: string
      sfdx-version:
        required: false
        type: string
    secrets:
      dev-hub-auth-url:
        required: true
      sendgrid-email-service-password-dev:
        required: true
jobs:
  feature-test-robot:
    name: "Feature Test - Robot"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Installing Salesforce CLI
        run: |
          npm install @salesforce/cli --global
          sfdx version

      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt-get install -y ./google-chrome-stable_current_amd64.deb

      - name: Run Robot Tests
        uses: cumulus-actions/feature-test-robot@v1
        with:
          dev-hub-auth-url: "${{ secrets.dev-hub-auth-url }}"
          cumulusci-version: "${{ inputs.cumulusci-version }}"
          sfdx-version: "${{ inputs.sfdx-version }}"
    env:
      SENDGRID_EMAIL_SERVICE_PASSWORD_DEV: ${{ secrets.sendgrid-email-service-password-dev }}

  build-feature-test-package:
    name: "Build Feature Test Package"
    runs-on: ubuntu-latest
    steps:
      - uses: cumulus-actions/build-feature-test-package@v1
        with:
          dev-hub-auth-url: ${{ secrets.dev-hub-auth-url }}
          cumulusci-version: "${{ inputs.cumulusci-version }}"
          sfdx-version: "${{ inputs.sfdx-version }}"
  feature-test-2gp:
    name: "Feature Test - 2GP"
    runs-on: ubuntu-latest
    needs:
      - build-feature-test-package
    steps:
      - uses: cumulus-actions/feature-test-2gp@v1
        with:
          dev-hub-auth-url: ${{ secrets.dev-hub-auth-url }}
          cumulusci-version: "${{ inputs.cumulusci-version }}"
          sfdx-version: "${{ inputs.sfdx-version }}"
